#!/usr/bin/env node

const { createProgram } = require('../lib/program')
const { info } = require('ara-console')
const afs = require('../')

const {
  displayConfirmationPrompt,
	promptForMnemonic,
	promptForPassword,
	onfatal
} = require('../lib/util')

// yargs program command line interface instance
const program = createProgram({
  usage: `
usage: afs destroy: [-h] [--help] [options]
`
})

const { argv } = program
  .command('$0 <did>', "Destroy AFS locally and remotely", (program) => {
    program
      .positional('did', {
        type: 'string',
        describe: "An AFS ARA decentralized identity (did) URI"
      })
      .option('force', {
        alias: 'f',
        type: 'boolean',
        describe: 'Force destroy operation',
      })
  }, ondestroy)

// Emit program usage help
if (0 == argv._.length && argv.help) {
  program.showHelp()
  process.exit(0)
}

async function ondestroy(argv) {
	const { did, force, secret, network, keyring } = argv
  info("attempting destroying AFS %s", did)

  const { password } = await promptForPassword()
  const { mnemonic } = await promptForMnemonic()

  let result = force
  if (!result) {
    const { answer } = await displayConfirmationPrompt({
      message: `Destroy will remove this AFS from the entire Ara network. Continue?`
    })
    result = answer
  }

  const keyringOpts = { secret, network, keyring }
  if (result) {
    try {
      await afs.destroy({ did, mnemonic, password, keyringOpts  })
    } catch (err) {
      onfatal(err)
    }
    info("destroyed AFS %s", did)
  }

  process.exit(1)
}
