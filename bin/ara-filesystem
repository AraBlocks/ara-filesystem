#!/usr/bin/env node

const debug = require('debug')('ara-filesystem')
const { info, warn, error, log } = require('ara-console')
const { basename, resolve } = require('path')
const { stat, access } = require('fs')
const cliWidth = require('cli-width')
const inquirer = require('inquirer')
const differ = require('ansi-diff-stream')
const pify = require('pify')
const program = require('yargs')
const afs = require('../')
const fs = require('fs')
const ProgressStream = require('progress-stream')
const ProgressBar = require('progress')
const bytes = require('pretty-bytes')
const table = require('table')

const isDirectory = require('is-directory')
const isFile = require('is-file')
const isSymlink = require('is-symlink')

const ignored = require('../lib/ignore')

const toLower = (x) => String(x).toLowerCase()
const $0 = basename(process.argv[1] || package.name)

process.on('unhandledRejection', onfatal)
process.on('uncaughtExeption', onfatal)

const { argv } = program
  .usage("usage: $0 [-hDV] [options] <command> [options]")
  .option('debug', {
    type: 'boolean',
    alias: 'D',
    describe: "Enable debug output"
  })
  .option('help', {
    alias: 'h',
    describe: "Show this help message"
  })
  .option('version', {
    alias: 'V',
    describe: "Show program version"
  })
  .command('create <owner>', "Create AFS with given identity", (program) => {
    program
      .positional('owner', {
        type: 'string',
        describe: "This AFS owner's ARA decentralized identity (did) URI"
      })
  }, oncreate)
  .command('add <did> <pathspec...>', "Add files or directories to an AFS", (program) => {
    program
      .positional('pathspec', {
        type: 'string',
        describe: "The file(s) you wish to add to AFS"
      })
      .positional('did', {
        type: 'string',
        describe: "An AFS ARA decentralized identity (did) URI"
      })
  }, onadd)
  .command('remove <did> <pathspec...>', "Remove files or directories from an AFS", (program) => {
    program
      .positional('pathspec', {
        type: 'string',
        describe: "The file(s) you wish to remove from AFS"
      })
      .positional('did', {
        type: 'string',
        describe: "An AFS ARA decentralized identity (did) URI"
      })
  }, onremove)
  .command('history <did>', "Retrieve the revision history of this AFS", (program) => {
    program
      .positional('did', {
        type: 'string',
        describe: "An AFS ARA decentralized identity (did) URI"
      })
  }, onhistory)
  .command('commit <did>', "Push local staged AFS changes to the Ethereum blockchain and DCDN", (program) => {
    program
      .positional('did', {
        type: 'string',
        describe: "An AFS ARA decentralized identity (did) URI"
      })
      .option('price', {
        alias: 'P',
        type: 'number',
        describe: "Price (in ARA) to set the cost of the AFS"
      })
  }, oncommit)
  .command('set-price <did> [price]', "Publish price for the given AFS", (program) => {
    program
      .positional('did', {
        type: 'string',
        describe: "An AFS ARA decentralized identity (did) URI"
      })
      .positional('price', {
        type: 'number',
        describe: "Cost associated with an AFS (in ARA)"
      })
  }, onsetprice)
  .command('get-price <did>', "Return the price for a given AFS", (program) => {
    program
      .positional('did', {
        type: 'string',
        describe: "An AFS ARA decentralized identity (did) URI"
      })
      .positional('price', {
        type: 'number',
        describe: "Cost associated with an AFS (in ARA)"
      })
  }, ongetprice)

void async function main() {
  if (argv.debug) {
    require('debug').enable('ara-filesystem*')
  }
}()

void async function main() {
  if (argv.debug) {
    require('debug').enable('ara-filesystem*')
  }
}()

async function oncreate(argv) {
  let owner = argv.owner

  if (null == owner) {
    onfatal(new Error("Missing AFS owner DID. See 'afs create --help'."))
  }

  if (0 == owner.indexOf('did:') && 0 != owner.indexOf('did:ara:')) {
    onfatal(new Error("Expecting a DID URI with an 'ara' method."))
  }

  if (0 != owner.indexOf('did:ara:')) {
    owner = 'did:ara:' + owner
  }

  const { password } = await promptForPassword()

  let arafs
  try {
    arafs = await afs.create({ owner, password })
  } catch (err) { onfatal(err) }

  info('New AFS created with DID: \n\n\t\t\t< %s >\n', arafs.afs.did)
  info('Please safely store the following 12 word mnemonic phrase for this AFS.' + 
    ' This phrase will be required to make any changes to the AFS.'+ 
    ' It will never be shown again: \n\n\t\t\t< %s >\n', arafs.mnemonic)

  arafs.afs.close()
}

async function onhistory(argv) {
  let did = argv.did
  if (null == did) {
    onfatal(new Error("Missing AFS DID. See 'afs add --help'."))
  }

  if (0 == did.indexOf('did:') && 0 != did.indexOf('did:ara:')) {
    onfatal(new Error("Expecting a DID URI with an 'ara' method."))
  }

  if (0 != did.indexOf('did:ara:')) {
    did = 'did:ara:' + did
  }

  const { password } = await promptForPassword()

  const tableOpts = {
    columnCount: 3,
    border: table.getBorderCharacters('ramac'),
    columnDefault: {
      paddingLeft: 1,
      paddingRight: 1,
      width: parseInt(((cliWidth() || 30) - 10)/3),
    },
    columns: [
      { width: 4 },
      { width: 4 },
      { width: 30 },
    ]
  }

  try {
    const arafs = await afs.create({ 
      did, 
      password })
    const stream = table.createStream(tableOpts)

    arafs.afs.history(argv.partition || arafs.afs.HOME)
      .on('error', onfatal)
      .on('end', () => process.exit(0))
      .on('data', (log) => {
        if (true != argv['border']) {
          console.log('%s\t%s\t%s',
            log.version,
            log.type.toUpperCase(),
            log.name
          )
        } else {
          stream.write([
            log.version,
            log.type.toUpperCase(),
            log.name,
          ])
        }
      })
  } catch (err) {
    error(err.message)
  }
}

async function onadd(argv) {
  let [ ...paths ] = argv.pathspec
  let did = argv.did

  if (!did) { onfatal(new Error("Missing AFS DID. See 'afs add --help'.")) }
  if (!paths || !paths.length) {
    onfatal(new Error("Missing local file paths. See 'afs add --help'."))
  }

  info("id: %s", did)
  info("paths: ", paths)

  const { password } = await promptForPassword()

  try {
    await afs.add({
      did,
      paths,
      password })
    info("file(s) successfully added")
  } catch (err) {
    error(err.message)
  }
}

async function onremove(argv) {
  let [ ...paths ] = argv.pathspec
  let did = argv.did

  if (!did) { onfatal(new Error("Missing AFS DID. See 'afs remove --help'.")) }
  if (!paths || !paths.length) {
    onfatal(new Error("Missing local file paths. See 'afs remove --help'."))
  }

  info("id: %s", did)
  info("paths: ", paths)

  const { password } = await promptForPassword()

  try {
    await afs.remove({
      did,
      paths,
      password })
    info("file(s) successfully removed")
  } catch (err) {
    error(err.message)
  }
}

async function oncommit({ did, price }) {
  if (!did) { onfatal(new Error("Missing AFS DID. See 'afs remove --help'.")) }

  const { password } = await promptForPassword()

  let result
  try {
    const cost = await afs.estimateCommitGasCost({ did, password, price })
    const { answer } = await promptCostConfirmation(cost)
    result = answer
  } catch (err) {
    onfatal(err)
  }

  if (result) {
    info("committing with identity: %s", did)
    const result = await afs.commit({ did, password, price })
    if (result instanceof Error) {
      error(result)
    } else {
      info("file(s) successfully committed")
    }
  } else {
    onfatal() // exit
  }
}

async function onsetprice({ did, price }) {
  price = price || 0
  info("setting price of AFS identity %s to %d", did, price)
  const { password } = await promptForPassword()

  let result
  try {
    const cost = await afs.estimateSetPriceGasCost({ did, password, price })
    const { answer } = await promptCostConfirmation(cost)
    result = answer
    if (answer) {
      await afs.setPrice({ did, password, price })
    }
  } catch (err) {
    onfatal(err)
  }

  if (result) {
    info("price has been set to", price)
  } else {
    onfatal() // exit
  }
}

async function ongetprice({did}) {
  info("getting price of AFS identity %s", did)
  const { password } = await promptForPassword()

  let price 
  try {
    price = await afs.getPrice({ did, password })
  } catch (err) {
    onfatal(err)
  }

  info("price of", did, "is", price)
}

async function promptCostConfirmation(cost) {
  return await inquirer.prompt({
    type: 'confirm',
    name: 'answer',
    message: 
    `This operation will cost ${cost} gas. Are you sure you
    want to proceed?`
  })
}

async function promptForPassword() {
  return await inquirer.prompt([{
    type: 'password',
    name: 'password',
    message:
    "Please provide the passphrase for your identity. This is needed to " +
    "complete this action.\n" +
    "Passphrase:"
  }]) 
}

function onfatal(err) {
  if (err) {
    debug(err)
    error("fatal:", err.message)
  }
  process.exit(1)
}
