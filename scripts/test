#!/bin/bash

safeRunCommand() {
  typeset cmnd="$*"
  typeset ret_code

  echo cmnd=$cmnd
  eval $cmnd

  ret_code=$?
  if [ $ret_code != 0 ]; then
    printf "Error : [%d] when executing command: '$cmnd'" $ret_code
    exit $ret_code
  fi
}

# installation
if ! command -v ganache-cli &> /dev/null; then
  npm install -g ganache-cli
fi

if ! command -v truffle &> /dev/null; then
  npm install -g truffle@5.3.1
fi

# run local truffle node
ganache-cli -l 0x7A1200 -q &
sleep 5

# ara node_modules/.bin to PATH
#PATH=$(npm bin):$PATH

# move deploy identity to home dir
mkdir -p ~/.ara/identities/
chmod +r ~/.ara/identities/
cp -a test/fixtures/identities/. ~/.ara/identities/

cd node_modules/ara-contracts
truffle migrate --network local

# deploy process doesn't close on its own, must sleep
sleep 20

cd ../..

command="ava test/add.js --verbose --timeout=20s"
safeRunCommand "$command"

command="ava test/commit.js --verbose --timeout=20s"
safeRunCommand "$command"

command="ava test/create.js --verbose --timeout=20s"
safeRunCommand "$command"

command="ava test/deploy.js --verbose --timeout=20s"
safeRunCommand "$command"

command="ava test/destroy.js --verbose --timeout=20s"
safeRunCommand "$command"

command="ava test/key-path.js --verbose --timeout=20s"
safeRunCommand "$command"

command="ava test/metadata.js --verbose --timeout=20s"
safeRunCommand "$command"

command="ava test/ownership.js --verbose --timeout=20s"
safeRunCommand "$command"

command="ava test/price.js --verbose --timeout=20s"
safeRunCommand "$command"

command="ava test/remove.js --verbose --timeout=20s"
safeRunCommand "$command"

command="ava test/storage.js --verbose --timeout=20s"
safeRunCommand "$command"

command="ava test/unarchive.js --verbose --timeout=20s"
safeRunCommand "$command"

command="ava test/util.js --verbose --timeout=20s"
safeRunCommand "$command"

# kill ganache
if command -v pkill &> /dev/null
then
  pkill -f ganache
elif command -v Taskkill &> /dev/null
then
  Taskkill /PID $pid -F
else
  echo "pkill and Taskkill could not be found"
fi
