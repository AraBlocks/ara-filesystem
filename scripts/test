#!/bin/bash

safeRunCommand() {
  typeset cmnd="$*"
  typeset ret_code

  echo cmnd=$cmnd
  eval $cmnd

  ret_code=$?
  if [ $ret_code != 0 ]; then
    printf "Error : [%d] when executing command: '$cmnd'" $ret_code
    exit $ret_code
  fi
}

# run local truffle node
ganache-cli -l 0x7A1200 &
sleep 5

# ara node_modules/.bin to PATH
PATH=$(npm bin):$PATH

# move deploy identity to home dir
mkdir -p ~/.ara/identities/
chmod +r ~/.ara/identities/
cp -a test/fixtures/identities/. ~/.ara/identities/

cd node_modules/ara-contracts
truffle migrate --network local

command="DEBUG=ara* act deploy standard 8a98c8305035dcbb1e8fa0826965200269e232e45ac572d26a45db9581986e67 -f -p pass \
1 ./contracts/AFS.sol ./contracts/Library.sol ./contracts/Registry.sol ./contracts/Proxy.sol ./contracts/AraToken.sol &"
safeRunCommand "$command"

# deploy process doesn't close on its own, must sleep
sleep 20

cd ../..

command="ava test --verbose"
safeRunCommand "$command"

# cleanup
pkill -f ganache
